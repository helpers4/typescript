name: Job - PR Comment

on:
  workflow_call:
    inputs:
      pr-number:
        required: true
        type: number
      version-status:
        required: true
        type: string
      build-status:
        required: true
        type: string
      test-status:
        required: true
        type: string
      lint-status:
        required: true
        type: string
      typecheck-status:
        required: true
        type: string
      commits-status:
        required: true
        type: string
      verify-status:
        required: true
        type: string
      coverage-lines:
        required: true
        type: string
      coverage-branches:
        required: true
        type: string
      coverage-functions:
        required: true
        type: string
      coverage-statements:
        required: true
        type: string

jobs:
  comment:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const jobs = [
              ['Version', '${{ inputs.version-status }}'],
              ['Build', '${{ inputs.build-status }}'],
              ['Tests', '${{ inputs.test-status }}'],
              ['Lint', '${{ inputs.lint-status }}'],
              ['TypeCheck', '${{ inputs.typecheck-status }}'],
              ['Commits', '${{ inputs.commits-status }}'],
              ['Verify', '${{ inputs.verify-status }}']
            ]

            const coverage = {
              lines: parseFloat('${{ inputs.coverage-lines }}') || 0,
              branches: parseFloat('${{ inputs.coverage-branches }}') || 0,
              functions: parseFloat('${{ inputs.coverage-functions }}') || 0,
              statements: parseFloat('${{ inputs.coverage-statements }}') || 0
            }

            const icon = (status) => {
              const icons = { success: 'âœ…', failure: 'âŒ', skipped: 'â­ï¸' }
              return icons[status] || 'âš ï¸'
            }

            const badge = (status) => {
              const badges = { success: 'passing', failure: 'failing', skipped: 'skipped' }
              return badges[status] || 'unknown'
            }

            const jobRows = jobs.map(([name, status]) => 
              '| ' + icon(status) + ' | **' + name + '** | ' + badge(status) + ' |'
            ).join('\n')

            const covIcon = (val) => {
              if (val >= 100) return 'âœ…'
              if (val >= 90) return 'ðŸŸ¢'
              if (val >= 80) return 'ðŸŸ¡'
              if (val >= 60) return 'ðŸŸ '
              return 'ðŸ”´'
            }

            const covRows = [
              '| ' + covIcon(coverage.lines) + ' | **Lines** | ' + coverage.lines + '% |',
              '| ' + covIcon(coverage.branches) + ' | **Branches** | ' + coverage.branches + '% |',
              '| ' + covIcon(coverage.functions) + ' | **Functions** | ' + coverage.functions + '% |',
              '| ' + covIcon(coverage.statements) + ' | **Statements** | ' + coverage.statements + '% |'
            ].join('\n')

            const passed = jobs.filter(([_, s]) => s === 'success').length
            const total = jobs.length
            const allPassed = passed === total
            const avgCov = ((coverage.lines + coverage.branches + coverage.functions + coverage.statements) / 4).toFixed(1)
            const covOk = parseFloat(avgCov) >= 100

            const banner = allPassed && covOk
              ? '## âœ… PR Validation Passed'
              : allPassed
                ? '## ðŸŸ¡ PR Validation Passed â€¢ Coverage ' + avgCov + '% (target: 100%)'
                : '## âŒ PR Validation Failed'

            const comment = banner + '\n\n---\n\n### Pipeline Status\n\n| | Job | Status |\n|:---:|-----|:------:|\n' + jobRows + '\n\n---\n\n### Code Coverage\n\n| | Metric | Coverage |\n|:---:|--------|:--------:|\n' + covRows + '\n\n---\n\n*Generated by @helpers4 CI*'

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ inputs.pr-number }},
            })

            const bot = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes('Pipeline Status')
            )

            if (bot) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: bot.id,
                body: comment
              })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.pr-number }},
                body: comment
              })
            }
