name: Job - Tests

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: "24"
      coverage:
        required: false
        type: boolean
        default: false
    outputs:
      status:
        description: "Test execution status"
        value: ${{ jobs.tests.outputs.status }}
      coverage-lines:
        description: "Lines coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-lines }}
      coverage-branches:
        description: "Branches coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-branches }}
      coverage-functions:
        description: "Functions coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-functions }}
      coverage-statements:
        description: "Statements coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-statements }}

jobs:
  tests:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.test.outputs.status }}
      coverage-lines: ${{ steps.coverage.outputs.lines }}
      coverage-branches: ${{ steps.coverage.outputs.branches }}
      coverage-functions: ${{ steps.coverage.outputs.functions }}
      coverage-statements: ${{ steps.coverage.outputs.statements }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        id: test
        run: |
          echo "Running unit tests with Vitest..."
          if [ "${{ inputs.coverage }}" = "true" ]; then
            if pnpm test:coverage; then
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            if pnpm test; then
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Extract coverage metrics
        id: coverage
        if: inputs.coverage == true
        run: |
          COVERAGE_FILE="coverage/coverage-summary.json"
          
          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "Coverage summary not found"
            exit 1
          fi
          
          TOTAL=$(jq '.total' "$COVERAGE_FILE")
          LINES=$(echo "$TOTAL" | jq '.lines.pct // 0')
          BRANCHES=$(echo "$TOTAL" | jq '.branches.pct // 0')
          FUNCTIONS=$(echo "$TOTAL" | jq '.functions.pct // 0')
          STATEMENTS=$(echo "$TOTAL" | jq '.statements.pct // 0')
          
          echo "lines=$LINES" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
