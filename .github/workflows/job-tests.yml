name: Job - Tests

on:
  workflow_call:
    inputs:
      node-version:
        required: false
        type: string
        default: "lts"
      coverage:
        required: false
        type: boolean
        default: false
    outputs:
      status:
        description: "Test execution status"
        value: ${{ jobs.tests.outputs.status }}
      coverage-lines:
        description: "Lines coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-lines }}
      coverage-branches:
        description: "Branches coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-branches }}
      coverage-functions:
        description: "Functions coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-functions }}
      coverage-statements:
        description: "Statements coverage percentage"
        value: ${{ jobs.tests.outputs.coverage-statements }}

jobs:
  tests:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.test.outputs.status }}
      coverage-lines: ${{ steps.coverage.outputs.lines }}
      coverage-branches: ${{ steps.coverage.outputs.branches }}
      coverage-functions: ${{ steps.coverage.outputs.functions }}
      coverage-statements: ${{ steps.coverage.outputs.statements }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        id: test
        run: |
          echo "Running unit tests with Vitest..."
          if [ "${{ inputs.coverage }}" = "true" ]; then
            if pnpm test:coverage; then
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          else
            if pnpm test; then
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: Extract coverage metrics
        id: coverage
        if: inputs.coverage == true
        run: |
          node -e "
          const fs = require('fs');
          const path = 'coverage/coverage-summary.json';
          if (!fs.existsSync(path)) {
            console.log('Coverage summary not found');
            process.exit(1);
          }
          const summary = JSON.parse(fs.readFileSync(path, 'utf8'));
          const total = summary.total || {};
          const getPct = (key) => (total[key] && typeof total[key].pct === 'number') ? total[key].pct : 0;
          const lines = getPct('lines');
          const branches = getPct('branches');
          const functions = getPct('functions');
          const statements = getPct('statements');
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `lines=${lines}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `branches=${branches}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `functions=${functions}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `statements=${statements}\n`);
          "
