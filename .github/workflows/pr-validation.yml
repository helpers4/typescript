name: Pull Request Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  issues: write

env:
  WORKFLOW_ID: ${{ github.run_id }}
  ARTIFACT_PACKAGE: package-json-${{ github.run_id }}
  ARTIFACT_BUILD: build-${{ github.run_id }}

jobs:
  # Security check for external contributors
  security-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository
    steps:
      - name: Check if PR is from external contributor
        run: |
          echo "::warning::This PR is from an external contributor. Manual review required before running CI."
          echo "::error::External PR detected. Workflow stopped for security."
          exit 1

  # Version calculation with artifact upload
  version-calculation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      version: ${{ steps.version.outputs.version }}
      version-changed: ${{ steps.version.outputs.changed }}
      status: ${{ steps.version.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Calculate version and upload artifact
        id: version
        uses: ./.github/actions/version-manager
        with:
          artifact-name: ${{ env.ARTIFACT_PACKAGE }}

  # Build project with artifact upload
  build:
    runs-on: ubuntu-latest
    needs: version-calculation
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      build-success: ${{ steps.build.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Build project and upload artifact
        id: build
        uses: ./.github/actions/build-project
        with:
          artifact-name: ${{ env.ARTIFACT_BUILD }}

  # Test job (runs in parallel with build)
  test:
    runs-on: ubuntu-latest
    needs: version-calculation
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      test-status: ${{ steps.test.outputs.status }}
      coverage-lines: ${{ steps.test.outputs.coverage-lines }}
      coverage-branches: ${{ steps.test.outputs.coverage-branches }}
      coverage-functions: ${{ steps.test.outputs.coverage-functions }}
      coverage-statements: ${{ steps.test.outputs.coverage-statements }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Run tests with coverage
        id: test
        uses: ./.github/actions/run-unit-tests
        with:
          coverage: "true"

  # Simple validation jobs
  security:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      security-status: ${{ steps.security.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run security audit
        id: security
        run: |
          echo "Running security audit..."
          pnpm audit || true
          echo "status=success" >> $GITHUB_OUTPUT

  lint:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      lint-status: ${{ steps.lint.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run linting
        id: lint
        uses: ./.github/actions/run-lint

  type-check:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      typecheck-status: ${{ steps.typecheck.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run TypeScript check
        id: typecheck
        uses: ./.github/actions/run-typecheck

  # Verification job (depends on build for artifacts)
  verification:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)

    outputs:
      verification-status: ${{ steps.verification.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Run verification tests
        id: verification
        uses: ./.github/actions/run-verification
        with:
          build-artifact: ${{ env.ARTIFACT_BUILD }}

  # PR comment with results
  pr-comment:
    runs-on: ubuntu-latest
    needs:
      [
        version-calculation,
        build,
        test,
        security,
        lint,
        type-check,
        verification,
      ]
    if: |
      always() && 
      (github.event_name == 'pull_request' || 
       (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository))

    steps:
      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const createJobsTable = (jobs) => {
              const rows = Object.entries(jobs).map(([job, status]) => {
                const icon = status === 'success' ? 'âœ…' : 
                           status === 'failure' ? 'âŒ' : 
                           status === 'skipped' ? 'â­ï¸' : 'âš ï¸';
                const statusBadge = status === 'success' ? '`passing`' :
                                   status === 'failure' ? '`failing`' :
                                   status === 'skipped' ? '`skipped`' : '`unknown`';
                return `| ${icon} | **${job}** | ${statusBadge} |`;
              }).join('\n');
              
              return `| | Job | Status |\n|:---:|-----|:------:|\n${rows}`;
            };

            const createCoverageSection = (coverage) => {
              const target = 100;
              const getStatus = (value) => {
                const num = parseFloat(value);
                if (num >= target) return { icon: 'âœ…', color: 'brightgreen', label: 'perfect' };
                if (num >= 90) return { icon: 'ğŸŸ¢', color: 'green', label: 'excellent' };
                if (num >= 80) return { icon: 'ğŸŸ¡', color: 'yellow', label: 'good' };
                if (num >= 60) return { icon: 'ğŸŸ ', color: 'orange', label: 'needs work' };
                return { icon: 'ğŸ”´', color: 'red', label: 'critical' };
              };
              
              const createProgressBar = (value) => {
                const pct = parseFloat(value);
                const filled = Math.floor(pct / 5);
                const empty = 20 - filled;
                return '`' + 'â–“'.repeat(filled) + 'â–‘'.repeat(empty) + '`';
              };

              const avgCoverage = (Object.values(coverage).reduce((a, b) => a + parseFloat(b), 0) / 4).toFixed(1);
              const avgStatus = getStatus(avgCoverage);

              const rows = Object.entries(coverage).map(([metric, value]) => {
                const status = getStatus(value);
                const bar = createProgressBar(value);
                return `| ${status.icon} | **${metric}** | ${bar} | **${value}%** |`;
              }).join('\n');
              
              const header = `
> ${avgStatus.icon} **Overall Coverage: ${avgCoverage}%** ${avgStatus.label === 'perfect' ? 'â€” Target reached! ğŸ¯' : `â€” Target: ${target}%`}

| | Metric | Progress | Coverage |
|:---:|--------|:--------:|:--------:|
${rows}`;
              
              return header;
            };

            const jobs = {
              'ğŸ”¢ Version': '${{ needs.version-calculation.outputs.status || 'unknown' }}',
              'ğŸ—ï¸ Build': '${{ needs.build.outputs.build-success || 'unknown' }}',
              'ğŸ§ª Tests': '${{ needs.test.outputs.test-status || 'unknown' }}',
              'ğŸ”’ Security': '${{ needs.security.outputs.security-status || 'unknown' }}',
              'ğŸ“ Lint': '${{ needs.lint.outputs.lint-status || 'unknown' }}',
              'ğŸ“˜ TypeCheck': '${{ needs.type-check.outputs.typecheck-status || 'unknown' }}',
              'ğŸ”— Coherency': '${{ needs.verification.outputs.verification-status || 'unknown' }}',
            };

            const coverage = {
              'Lines': '${{ needs.test.outputs.coverage-lines || '0' }}',
              'Branches': '${{ needs.test.outputs.coverage-branches || '0' }}',
              'Functions': '${{ needs.test.outputs.coverage-functions || '0' }}',
              'Statements': '${{ needs.test.outputs.coverage-statements || '0' }}',
            };

            const passedCount = Object.values(jobs).filter(s => s === 'success').length;
            const totalJobs = Object.keys(jobs).length;
            const allPassed = passedCount === totalJobs;
            const avgCoverage = (Object.values(coverage).reduce((a, b) => a + parseFloat(b), 0) / 4).toFixed(1);
            const coverageOk = parseFloat(avgCoverage) >= 100;

            const statusBanner = allPassed && coverageOk 
              ? '## âœ… PR Validation Passed\n\n> All checks passed and coverage target reached!'
              : allPassed 
                ? `## ğŸŸ¡ PR Validation Passed\n\n> All checks passed â€¢ Coverage: ${avgCoverage}% (target: 100%)`
                : `## âŒ PR Validation Failed\n\n> ${passedCount}/${totalJobs} checks passed`;

            const comment = `${statusBanner}

---

### ğŸ“‹ Pipeline Status

${createJobsTable(jobs)}

---

### ğŸ“Š Code Coverage

${createCoverageSection(coverage)}

---

<details>
<summary>â„¹ï¸ <b>About this report</b></summary>

- ğŸ¯ **Coverage Target**: 100% for all metrics
- ğŸ”„ This comment updates automatically with each push
- ğŸ“ˆ Coverage is measured using Vitest + v8

</details>

<sub>ğŸ¤– Generated by **@helpers4** CI â€¢ ${new Date().toISOString().split('T')[0]}</sub>`;

            try {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && comment.body.includes('PR Validation')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
                console.log('Updated existing comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
                console.log('Created new comment');
              }
            } catch (error) {
              console.error('Error updating PR comment:', error);
              console.log('Comment update failed, but continuing workflow...');
            }
