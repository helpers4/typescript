name: Pull Request Validation

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  issues: write

env:
  WORKFLOW_ID: ${{ github.run_id }}
  ARTIFACT_PACKAGE: package-json-${{ github.run_id }}
  ARTIFACT_BUILD: build-${{ github.run_id }}

jobs:
  # Version calculation with artifact upload
  version-calculation:
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      version-changed: ${{ steps.version.outputs.changed }}
      status: ${{ steps.version.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get current version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "status=success" >> $GITHUB_OUTPUT
          echo "changed=false" >> $GITHUB_OUTPUT

  # Build project with artifact upload
  build:
    needs: version-calculation
    uses: ./.github/workflows/job-build.yml
    with:
      node-version: "24"
      upload-artifact: true
      artifact-name: build-${{ github.run_id }}

  # Test job (runs in parallel with build)
  test:
    needs: version-calculation
    uses: ./.github/workflows/job-tests.yml
    with:
      node-version: "24"
      coverage: true

  lint:
    uses: ./.github/workflows/job-lint.yml
    with:
      node-version: "24"

  type-check:
    uses: ./.github/workflows/job-typecheck.yml
    with:
      node-version: "24"

  conventional-commits:
    runs-on: ubuntu-latest
    outputs:
      status: ${{ steps.check.outputs.status }}
    steps:
      - name: Validate conventional commits
        id: check
        uses: helpers4/action/conventional-commits@main
        with:
          pr-comment: error

  # Verification job (depends on build for artifacts)
  verification:
    needs: [build, test]
    uses: ./.github/workflows/job-verification.yml
    with:
      node-version: "24"
      build-artifact: build-${{ github.run_id }}

  # PR comment with results
  pr-comment:
    if: always()
    needs:
      [
        version-calculation,
        build,
        test,
        lint,
        type-check,
        conventional-commits,
        verification,
      ]
    uses: ./.github/workflows/job-pr-comment.yml
    with:
      pr-number: ${{ github.event.pull_request.number }}
      version-status: ${{ needs.version-calculation.outputs.status || 'unknown' }}
      build-status: ${{ needs.build.outputs.status || 'unknown' }}
      test-status: ${{ needs.test.outputs.status || 'unknown' }}
      lint-status: ${{ needs.lint.outputs.status || 'unknown' }}
      typecheck-status: ${{ needs.type-check.outputs.status || 'unknown' }}
      commits-status: ${{ needs.conventional-commits.outputs.status || 'unknown' }}
      verify-status: ${{ needs.verification.outputs.status || 'unknown' }}
      coverage-lines: ${{ needs.test.outputs.coverage-lines || '0' }}
      coverage-branches: ${{ needs.test.outputs.coverage-branches || '0' }}
      coverage-functions: ${{ needs.test.outputs.coverage-functions || '0' }}
      coverage-statements: ${{ needs.test.outputs.coverage-statements || '0' }}
