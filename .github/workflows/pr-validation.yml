name: Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  pull_request_target:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened, ready_for_review ]

permissions:
  contents: read
  pull-requests: write
  checks: write
  statuses: write
  issues: write

env:
  WORKFLOW_ID: ${{ github.run_id }}
  ARTIFACT_PACKAGE: package-json-${{ github.run_id }}
  ARTIFACT_BUILD: build-${{ github.run_id }}

jobs:
  # Security check for external contributors
  security-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name != github.repository
    steps:
      - name: Check if PR is from external contributor
        run: |
          echo "::warning::This PR is from an external contributor. Manual review required before running CI."
          echo "::error::External PR detected. Workflow stopped for security."
          exit 1

  # Version calculation with artifact upload
  version-calculation:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      version: ${{ steps.version.outputs.version }}
      version-changed: ${{ steps.version.outputs.changed }}
      status: ${{ steps.version.outputs.status }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0

      - name: Calculate version and upload artifact
        id: version
        uses: ./.github/actions/version-manager
        with:
          artifact-name: ${{ env.ARTIFACT_PACKAGE }}

  # Build project with artifact upload
  build:
    runs-on: ubuntu-latest
    needs: version-calculation
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      build-success: ${{ steps.build.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Build project and upload artifact
        id: build
        uses: ./.github/actions/build-project
        with:
          artifact-name: ${{ env.ARTIFACT_BUILD }}

  # Test job (runs in parallel with build)
  test:
    runs-on: ubuntu-latest
    needs: version-calculation
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      test-status: ${{ steps.test.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Run tests
        id: test
        uses: ./.github/actions/run-unit-tests

  # Simple validation jobs
  security:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      security-status: ${{ steps.security.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        id: security
        run: |
          echo "Running security audit..."
          npm audit || true
          echo "status=success" >> $GITHUB_OUTPUT

  lint:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      lint-status: ${{ steps.lint.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        id: lint
        uses: ./.github/actions/run-lint

  type-check:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      typecheck-status: ${{ steps.typecheck.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run TypeScript check
        id: typecheck
        uses: ./.github/actions/run-typecheck

  # Verification job (depends on build for artifacts)
  verification:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: |
      github.event_name == 'pull_request' || 
      (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository)
    
    outputs:
      verification-status: ${{ steps.verification.outputs.status }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'pull_request_target' && github.event.pull_request.head.sha || github.sha }}

      - name: Run verification tests
        id: verification
        uses: ./.github/actions/run-verification
        with:
          build-artifact: ${{ env.ARTIFACT_BUILD }}

  # PR comment with results
  pr-comment:
    runs-on: ubuntu-latest
    needs: [version-calculation, build, test, security, lint, type-check, verification]
    if: |
      always() && 
      (github.event_name == 'pull_request' || 
       (github.event_name == 'pull_request_target' && github.event.pull_request.head.repo.full_name == github.repository))
    
    steps:
      - name: Update PR comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const createSummaryTable = (jobs) => {
              const rows = Object.entries(jobs).map(([job, status]) => {
                const icon = status === 'success' ? 'âœ…' : 
                           status === 'failure' ? 'âŒ' : 
                           status === 'skipped' ? 'â­ï¸' : 'âš ï¸';
                return `| ${job} | ${icon} ${status} |`;
              }).join('\n');
              
              return `## ðŸ” PR Validation Summary\n\n| Job | Status |\n|-----|--------|\n${rows}`;
            };
            
            const jobs = {
              'Version Calculation': '${{ needs.version-calculation.outputs.status || 'unknown' }}',
              'Build': '${{ needs.build.outputs.build-success || 'unknown' }}',
              'Test': '${{ needs.test.outputs.test-status || 'unknown' }}',
              'Security Audit': '${{ needs.security.outputs.security-status || 'unknown' }}',
              'Lint': '${{ needs.lint.outputs.lint-status || 'unknown' }}',
              'Type Check': '${{ needs.type-check.outputs.typecheck-status || 'unknown' }}',
              'Coherency Tests': '${{ needs.verification.outputs.verification-status || 'unknown' }}',
            };
            
            const comment = createSummaryTable(jobs);
            
            try {
              // Find existing comment or create new one
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              
              const botComment = comments.find(comment => 
                comment.user.type === 'Bot' && comment.body.includes('PR Validation Summary')
              );
              
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: comment
                });
                console.log('Updated existing comment');
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: comment
                });
                console.log('Created new comment');
              }
            } catch (error) {
              console.error('Error updating PR comment:', error);
              // Don't fail the workflow if comment update fails
              console.log('Comment update failed, but continuing workflow...');
            }
